var Editor=function(d){function o(a,b,e,d,f){function c(c){b[e]=d(a.val());if(!c||!c.batch)if("function"===typeof f)f({operation:b,property:e,value:b[e]});else if(f.length)for(c=0;c<f.length;c++)f[c]({operation:b,property:e,value:b[e]})}a.keyup(c).change(c);return c}function l(a,b){return d(b?"<"+b+"></"+b+">":"<span></span>").html(a)}function m(a){var b=parseInt(a,10);try{if(isNaN(b)||b.toString()!==a)return new Function("return "+a+";")}catch(d){}return b}function p(a){return function(b){var d=
m(b);a(b);return d}}function s(a){return new Color(a)}function t(a){return Font[a]}function u(a){return Icon[a]}function v(a){return a}function n(a){"function"===typeof a&&(a=a.toString(),a={name:a.match(/function\s+(\w*)\s*\([^\)]*\)\s*\{/)[1],parameters:a.match(/function\s+\w*\s*\([^\)]*\)\s*\{/)[1],expression:a.match(/\{\s*return\s+([^;]+);\s*\}/)[1]}.expression);return a}return{integer:function(a,b,e){var h=b.mapping.integer,f=d.extend({},Primitives[a.command].defaults,a),f=n(f[h]),c=d("<span></span>"),
g=d("<input/>").attr("type","text").val(f),i=d("<div></div>").slider({min:b.min||0,max:b.max||320,value:f,slide:function(a,b){g.val(b.value);k()}}),k=o(g,a,h,m,[e,function(){i.slider("value",g.val())}]);c.append(g,i);return c},coordinates:function(a,b,e){var h=b.mapping.x,b=b.mapping.y,f=d.extend({},Primitives[a.command].defaults,a),c=d("<input/>").attr("type","text").val(n(f[h])),g=d("<input/>").attr("type","text").val(n(f[b])),i=a.canvas.position(),f=function(){var a=m(c.val()),b=m(g.val());"number"===
typeof a&&"number"===typeof b?j.show().css({left:i.left+a-3+"px",top:i.top+b-3+"px"}):j.hide()},k=d("<span></span>").append(l("X: "),c,l("Y: "),g).bind("operation-selected",f).bind("operation-deselected",function(){j.hide()}),j=d("<div></div>").addClass("handle").css({position:"absolute",cursor:"move",width:"5px",height:"5px",border:"solid 1px black",backgroundColor:"white"}).data({operation:a}).hide().draggable({containment:[i.left-3,i.top-3,i.left+a.canvas.width()-3-1,i.top+a.canvas.height()-3-
1],drag:function(a,b){c.val(b.offset.left-i.left+3);g.val(b.offset.top-i.top+3);q({batch:!0});r()}});a.canvas.after(j);var q=o(c,a,h,p(f),e),r=o(g,a,b,p(f),e);return k},coordinates3d:function(a,b){var e=b.mapping.x,h=b.mapping.y,f=b.mapping.z,c=d.extend({},Primitives[a.command].defaults,a),g=d("<input/>").attr("type","text").val(n(c[e])),i=d("<input/>").attr("type","text").val(n(c[h])),k=d("<input/>").attr("type","text").val(n(c[f])),e=a.canvas.position(),h=d("<span></span>").append(l("X: "),g,l("Y: "),
i,l("Z: "),k).bind("operation-selected",function(){var a=m(g.val()),b=m(i.val()),c=m(k.val());"number"===typeof a&&"number"===typeof b&&"number"===typeof c||j.hide()}).bind("operation-deselected",function(){j.hide()}),j=d("<div></div>").addClass("handle").css({position:"absolute",cursor:"move",width:"5px",height:"5px",border:"solid 1px black",backgroundColor:"white"}).data({operation:a}).hide().draggable({containment:[e.left-3,e.top-3,e.left+a.canvas.width()-3-1,e.top+a.canvas.height()-3-1],drag:function(){}});
a.canvas.after(j);return h},vector:function(a,b){var e=b.mapping.x,h=b.mapping.y,f=b.mapping.z,c=d.extend({},Primitives[a.command].defaults,a),g=d("<input/>").attr("type","text").val(n(c[e])),i=d("<input/>").attr("type","text").val(n(c[h])),k=d("<input/>").attr("type","text").val(n(c[f])),e=a.canvas.position(),h=d("<span></span>").append(l("X: "),g,l("Y: "),i,l("Z: "),k).bind("operation-selected",function(){var a=m(g.val()),b=m(i.val()),c=m(k.val());"number"===typeof a&&"number"===typeof b&&"number"===
typeof c||j.hide()}).bind("operation-deselected",function(){j.hide()}),j=d("<div></div>").addClass("handle").css({position:"absolute",cursor:"move",width:"5px",height:"5px",border:"solid 1px black",backgroundColor:"white"}).data({operation:a}).hide().draggable({containment:[e.left-3,e.top-3,e.left+a.canvas.width()-3-1,e.top+a.canvas.height()-3-1],drag:function(){}});a.canvas.after(j);return h},range:function(a,b,e){var h=b.mapping.from,f=b.mapping.to,c=d.extend({},Primitives[a.command].defaults,a),
g=n(c[h]),i=n(c[f]),c=d("<span></span>"),k=d("<input/>").attr("type","text").val(g),j=d("<input/>").attr("type","text").val(i),q=d("<div></div>").slider({range:!0,min:b.min||0,max:b.max||100,values:[g,i],slide:function(a,b){b.values[0]!==k.val()&&(k.val(b.values[0]),r());b.values[1]!==j.val()&&(j.val(b.values[1]),p())}}),b=function(){q.slider("values",[k.val(),j.val()])},r=o(k,a,h,m,[e,b]),p=o(j,a,f,m,[e,b]);c.append(l("From: "),k,l("To: "),j,q);return c},string:function(a,b,e){var b=b.mapping.text,
h=d.extend({},Primitives[a.command].defaults,a)[b],h=d("<input/>").attr("type","text").val(h);o(h,a,b,v,e);return h},enumeration:function(a,b,e){var h=b.enumeration,b=b.mapping.enumeration,f=d.extend({},Primitives[a.command].defaults,a)[b],c=d("<select/>"),g;for(g in h)c.append(d("<option/>").html(g));c.val(f.name);o(c,a,b,function(a){return h[a]},e);return c},font:function(a,b,e){var b=b.mapping.font,h=d.extend({},Primitives[a.command].defaults,a)[b],f=d("<select/>"),c;for(c in Font){var g=Font[c];
if("object"===typeof g){var i=d("<option/>").html(g.name).val(c);f.append(i);g===h&&i.attr("selected","selected")}}o(f,a,b,t,e);return f},icon:function(a,b,e){var b=b.mapping.icon,h=d.extend({},Primitives[a.command].defaults,a)[b],f=d("<select/>"),c;for(c in Icon){var g=Icon[c];if(g.isIcon){var i=d("<option/>").html(g.name).val(c);f.append(i);g===h&&i.attr("selected","selected")}}o(f,a,b,u,e);return f},color:function(a,b,e){var b=b.mapping.color,h=d.extend({},Primitives[a.command].defaults,a)[b],
f=d("<span></span>"),c=d("<input/>").attr("type","text").val("#"+Color.hex(h)).focus(function(){g.show()}).blur(function(){g.hide()}),g=d("<div></div>").hide().farbtastic(function(a){i||(c.val(a),k())}),i=!1,k=o(c,a,b,s,[e,function(){i=!0;d.farbtastic(g).setColor((new Color(c.val())).toHtml());i=!1}]);f.append(c,g);return f},program:function(a,b,e){b=b.mapping.program;b=d.extend({},Primitives[a.command].defaults,a)[b];a=d("<ol></ol>").addClass("operation").data({operation:b,canvas:a.canvas});Editor.buildEditors(b,
a,e);return a},buildEditor:function(a,b,e,h,f){a.parent=b;a.canvas=e.data("canvas");var b=Primitives[a.command],c=d("<li></li>").append(l(b.name,"h2").css("cursor","move").append(d("<a></a>").html("Delete").attr("href","#").addClass("delete"))).addClass("operation").data("operation",a);if(b.editor)for(var g=0;g<b.editor.length;g++){var i=b.editor[g],k=i.type(a,i,h);if(k){var j=d("<div></div>").addClass("edit-area");i.label&&j.append(l(i.label+": "));k.addClass("property-editor");j.append(k);c.append(j)}}0===
e.children().length&&c.addClass("first");f?c.insertAfter(f):e.append(c);return a.editor=c},buildEditors:function(a,b,d){b.empty();a.editor=b;b.data("operation",a);for(var h=0;h<a.length;h++)Editor.buildEditor(a[h],a,b,d);d()}}}(jQuery);